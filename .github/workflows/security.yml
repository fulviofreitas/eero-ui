# ============================================================================
# ğŸ” Security Static Analysis with Opengrep
# ============================================================================
# This workflow runs Opengrep SAST (Static Application Security Testing) to
# detect security vulnerabilities, code quality issues, and potential bugs.
#
# Features:
# - Scans both frontend (Svelte/TypeScript) and backend (Python) code
# - Uses custom security rules from the security-rules/ directory
# - Uploads SARIF results to GitHub Security tab for visibility
# - Comments on PRs when security findings are detected
# - Fails the workflow if critical vulnerabilities are found
# ============================================================================

name: ğŸ” Security Scan

on:
  # Run on all pull requests to protected branches
  pull_request:
    branches:
      - main
      - master
      - develop
    paths:
      - 'frontend/**'
      - 'backend/**'
      - 'security-rules/**'
      - '.github/workflows/security.yml'
  
  # Run on pushes to the default branch
  push:
    branches:
      - main
      - master
    paths:
      - 'frontend/**'
      - 'backend/**'
      - 'security-rules/**'
      - '.github/workflows/security.yml'
  
  # Allow manual trigger for ad-hoc security audits
  workflow_dispatch:
    inputs:
      fail_on_findings:
        description: 'Fail workflow if vulnerabilities found'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write    # Required for uploading SARIF to GitHub Security
  pull-requests: write      # Required for commenting on PRs
  actions: read             # Required for workflow status

env:
  # Opengrep configuration
  OPENGREP_RULES_PATH: security-rules
  OPENGREP_SCAN_PATH: .
  SARIF_OUTPUT: results.sarif

jobs:
  # ============================================================================
  # ğŸ” Security Scan Job
  # ============================================================================
  security-scan:
    name: ğŸ” Opengrep SAST Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      # ----------------------------------------------------------------------
      # ğŸ“¥ Checkout Repository
      # ----------------------------------------------------------------------
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for accurate scanning

      # ----------------------------------------------------------------------
      # ğŸ› ï¸ Install Opengrep
      # Download binary directly from GitHub releases for reliability
      # ----------------------------------------------------------------------
      - name: ğŸ› ï¸ Install Opengrep
        id: install
        run: |
          echo "ğŸ“¦ Installing Opengrep..."
          
          # Get the latest release version
          OPENGREP_VERSION=$(curl --silent "https://api.github.com/repos/opengrep/opengrep/releases/latest" | \
            grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
          
          if [ -z "$OPENGREP_VERSION" ]; then
            echo "::warning::Could not fetch latest version, using fallback v1.15.0"
            OPENGREP_VERSION="v1.15.0"
          fi
          
          echo "opengrep_version=${OPENGREP_VERSION}" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ Using Opengrep version: $OPENGREP_VERSION"
          
          # Download the Linux x86_64 binary
          DOWNLOAD_URL="https://github.com/opengrep/opengrep/releases/download/${OPENGREP_VERSION}/opengrep-core_linux_x86.tar.gz"
          echo "â¬‡ï¸ Downloading from: $DOWNLOAD_URL"
          
          curl -fsSL "$DOWNLOAD_URL" -o opengrep.tar.gz || {
            echo "::error::Failed to download Opengrep binary"
            exit 1
          }
          
          # Extract and install
          tar -xzf opengrep.tar.gz
          chmod +x opengrep-core
          sudo mv opengrep-core /usr/local/bin/opengrep
          
          # Verify installation
          opengrep --version || opengrep --help || echo "ğŸ“‹ Opengrep installed"
          echo "âœ… Opengrep installation complete"

      # ----------------------------------------------------------------------
      # ğŸ“‹ Validate Security Rules
      # Ensure the rules directory exists and has valid rules
      # ----------------------------------------------------------------------
      - name: ğŸ“‹ Validate security rules
        id: rules
        run: |
          if [ ! -d "${{ env.OPENGREP_RULES_PATH }}" ]; then
            echo "::error::Security rules directory '${{ env.OPENGREP_RULES_PATH }}' not found"
            echo "Please create the directory and add YAML rule files"
            exit 1
          fi
          
          RULE_COUNT=$(find ${{ env.OPENGREP_RULES_PATH }} -name "*.yaml" -o -name "*.yml" | wc -l)
          echo "rule_count=${RULE_COUNT}" >> $GITHUB_OUTPUT
          echo "ğŸ“Š Found ${RULE_COUNT} rule file(s)"
          
          if [ "$RULE_COUNT" -eq 0 ]; then
            echo "::warning::No YAML rule files found in ${{ env.OPENGREP_RULES_PATH }}"
          fi
          
          # List rules for visibility
          echo "ğŸ“ Rule files:"
          find ${{ env.OPENGREP_RULES_PATH }} -name "*.yaml" -o -name "*.yml" | head -20

      # ----------------------------------------------------------------------
      # ğŸ” Run Opengrep Security Scan
      # Scans the entire codebase with custom rules and outputs SARIF
      # ----------------------------------------------------------------------
      - name: ğŸ” Run Opengrep security scan
        id: scan
        run: |
          echo "ğŸ” Starting security scan..."
          echo "   Rules: ${{ env.OPENGREP_RULES_PATH }}"
          echo "   Target: ${{ env.OPENGREP_SCAN_PATH }}"
          echo ""
          
          # Run the scan with SARIF output
          # Use --sarif and --output flags (correct Opengrep syntax)
          opengrep scan \
            --config ${{ env.OPENGREP_RULES_PATH }} \
            ${{ env.OPENGREP_SCAN_PATH }} \
            --sarif \
            --output=${{ env.SARIF_OUTPUT }} \
            --json \
            --output=results.json \
            2>&1 | tee scan-output.txt
          
          SCAN_EXIT_CODE=${PIPESTATUS[0]}
          echo "scan_exit_code=${SCAN_EXIT_CODE}" >> $GITHUB_OUTPUT
          
          # Parse findings from the console output
          # Look for the "X Code Findings" line in the output
          FINDING_COUNT=$(grep -oP '\d+(?= Code Findings)' scan-output.txt 2>/dev/null || echo "0")
          if [ -z "$FINDING_COUNT" ]; then
            FINDING_COUNT="0"
          fi
          echo "finding_count=${FINDING_COUNT}" >> $GITHUB_OUTPUT
          
          # Parse files scanned
          FILES_SCANNED=$(grep -oP 'Scanning \K\d+(?= files)' scan-output.txt 2>/dev/null || echo "0")
          echo "files_scanned=${FILES_SCANNED}" >> $GITHUB_OUTPUT
          
          # Parse rules count
          RULES_USED=$(grep -oP 'with \K\d+(?= Code rules)' scan-output.txt 2>/dev/null || echo "0")
          echo "rules_used=${RULES_USED}" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š Scan complete: ${FINDING_COUNT} findings in ${FILES_SCANNED} files using ${RULES_USED} rules"
          
          # Check if SARIF was generated, if not create minimal valid SARIF
          if [ ! -f "${{ env.SARIF_OUTPUT }}" ]; then
            echo "âš ï¸ SARIF file not generated, creating minimal SARIF from scan results"
            cat > ${{ env.SARIF_OUTPUT }} << 'EOF'
          {
            "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
            "version": "2.1.0",
            "runs": [{
              "tool": {
                "driver": {
                  "name": "Opengrep",
                  "version": "${{ steps.install.outputs.opengrep_version }}",
                  "informationUri": "https://opengrep.dev"
                }
              },
              "results": []
            }]
          }
          EOF
          fi
          
          echo "âœ… Scan completed"

      # ----------------------------------------------------------------------
      # ğŸ“¤ Upload SARIF to GitHub Security Tab
      # This enables the Security tab alerts and code scanning results
      # ----------------------------------------------------------------------
      - name: ğŸ“¤ Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: ${{ env.SARIF_OUTPUT }}
          category: opengrep-security-scan

      # ----------------------------------------------------------------------
      # ğŸ“Š Upload Scan Artifacts
      # Keep scan results for debugging and audit trail
      # ----------------------------------------------------------------------
      - name: ğŸ“Š Upload scan artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-scan-results
          path: |
            ${{ env.SARIF_OUTPUT }}
            results.json
            scan-output.txt
          retention-days: 30

      # ----------------------------------------------------------------------
      # ğŸ“ Generate Beautiful Workflow Summary
      # Modern, human-readable summary in the Actions tab
      # ----------------------------------------------------------------------
      - name: ğŸ“ Generate workflow summary
        if: always()
        run: |
          FINDING_COUNT="${{ steps.scan.outputs.finding_count }}"
          FILES_SCANNED="${{ steps.scan.outputs.files_scanned }}"
          RULES_USED="${{ steps.scan.outputs.rules_used }}"
          RULE_FILES="${{ steps.rules.outputs.rule_count }}"
          OPENGREP_VERSION="${{ steps.install.outputs.opengrep_version }}"
          
          # Default values if empty
          FINDING_COUNT=${FINDING_COUNT:-0}
          FILES_SCANNED=${FILES_SCANNED:-0}
          RULES_USED=${RULES_USED:-0}
          
          # Header with banner
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ğŸ” Opengrep Security Scan Report
          
          EOF
          
          # Status banner based on findings
          if [ "$FINDING_COUNT" = "0" ]; then
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          > [!NOTE]
          > ### âœ… All Clear â€” No Security Issues Detected
          > Your code passed all security checks. Great job maintaining secure code!
          
          EOF
          else
            cat >> $GITHUB_STEP_SUMMARY << EOF
          > [!WARNING]
          > ### âš ï¸ Security Findings Detected: ${FINDING_COUNT} issue(s)
          > Review the findings below and address them before merging.
          
          EOF
          fi
          
          # Metrics dashboard
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ğŸ“Š Scan Metrics
          
          | Metric | Value |
          |:-------|------:|
          | ğŸ” **Findings** | **${FINDING_COUNT}** |
          | ğŸ“ Files Scanned | ${FILES_SCANNED} |
          | ğŸ“‹ Rules Applied | ${RULES_USED} |
          | ğŸ“¦ Rule Files | ${RULE_FILES} |
          
          EOF
          
          # Show findings details if any exist
          if [ "$FINDING_COUNT" != "0" ] && [ -f "scan-output.txt" ]; then
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ğŸš¨ Findings by File
          
          <details>
          <summary>Click to expand findings details</summary>
          
          ```
          EOF
            # Extract the findings section from scan output
            sed -n '/Code Findings/,/Scan Summary/p' scan-output.txt | head -100 >> $GITHUB_STEP_SUMMARY
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ```
          
          </details>
          
          EOF
          fi
          
          # Configuration section
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## âš™ï¸ Configuration
          
          | Setting | Value |
          |:--------|:------|
          | Scanner | Opengrep ${OPENGREP_VERSION} |
          | Rules Directory | \`${{ env.OPENGREP_RULES_PATH }}/\` |
          | Scan Target | \`${{ env.OPENGREP_SCAN_PATH }}\` |
          | Output Format | SARIF 2.1.0 |
          | Trigger | \`${{ github.event_name }}\` |
          | Commit | \`${{ github.sha }}\` |
          
          EOF
          
          # Next steps section
          if [ "$FINDING_COUNT" != "0" ]; then
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ğŸ“‹ Next Steps
          
          1. **Review Findings** â€” Check the [Security tab](../../security/code-scanning) for detailed alerts
          2. **Fix Issues** â€” Address high-severity findings first
          3. **Re-run Scan** â€” Push fixes and verify the scan passes
          
          > ğŸ’¡ **Tip:** Click on individual alerts in the Security tab to see affected code and remediation guidance.
          
          EOF
          else
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ğŸ‰ Keep It Up!
          
          Your codebase is following security best practices. Continue to:
          - Add new security rules as threats evolve
          - Review the [Security tab](../../security/code-scanning) periodically
          - Keep dependencies updated
          
          EOF
          fi
          
          # Footer
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ---
          
          <sub>ğŸ¤– Generated by the Opengrep Security Scan workflow</sub>
          EOF

      # ----------------------------------------------------------------------
      # ğŸ’¬ Comment on PR with Findings Summary
      # Provides visibility directly in the PR conversation
      # ----------------------------------------------------------------------
      - name: ğŸ’¬ Comment on PR with findings
        if: github.event_name == 'pull_request' && steps.scan.outputs.finding_count != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const findingCount = '${{ steps.scan.outputs.finding_count }}';
            const filesScanned = '${{ steps.scan.outputs.files_scanned }}';
            const rulesUsed = '${{ steps.scan.outputs.rules_used }}';
            
            const body = `## ğŸ” Security Scan Results
            
            | Metric | Value |
            |:-------|------:|
            | âš ï¸ **Findings** | **${findingCount}** |
            | ğŸ“ Files Scanned | ${filesScanned} |
            | ğŸ“‹ Rules Applied | ${rulesUsed} |
            
            ### ğŸ“‹ Next Steps
            
            1. Check the **[Security tab](../../security/code-scanning)** for detailed findings
            2. Review the workflow summary for finding details
            3. Address high-severity issues before merging
            
            > ğŸ’¡ Click on alerts in the Security tab to see affected code and remediation guidance.
            
            ---
            <sub>ğŸ¤– Generated by Opengrep Security Scan</sub>`;

            // Check if we already commented to avoid duplicates
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const existingComment = comments.find(c => 
              c.user.type === 'Bot' && 
              c.body.includes('ğŸ” Security Scan Results')
            );
            
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      # ----------------------------------------------------------------------
      # ğŸš¨ Fail Workflow on Findings (Configurable)
      # This step fails the workflow if security issues are found
      # Can be disabled via workflow_dispatch input
      # ----------------------------------------------------------------------
      - name: ğŸš¨ Check for critical findings
        if: always()
        run: |
          FINDING_COUNT="${{ steps.scan.outputs.finding_count }}"
          FAIL_ON_FINDINGS="${{ github.event.inputs.fail_on_findings || 'true' }}"
          
          # Default to 0 if empty
          FINDING_COUNT=${FINDING_COUNT:-0}
          
          if [ "$FINDING_COUNT" != "0" ]; then
            echo "::warning::Found ${FINDING_COUNT} security finding(s)"
            
            if [ "$FAIL_ON_FINDINGS" = "true" ]; then
              echo ""
              echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
              echo "â•‘  ğŸš¨ SECURITY SCAN FAILED                                   â•‘"
              echo "â•‘                                                            â•‘"
              echo "â•‘  Found ${FINDING_COUNT} security finding(s) that need attention.     â•‘"
              echo "â•‘                                                            â•‘"
              echo "â•‘  Review the workflow summary and Security tab for details. â•‘"
              echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo ""
              echo "::error::Security scan failed: ${FINDING_COUNT} finding(s) detected"
              exit 1
            else
              echo "::notice::Continuing despite ${FINDING_COUNT} finding(s) (fail_on_findings=false)"
            fi
          else
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘  âœ… SECURITY SCAN PASSED                                   â•‘"
            echo "â•‘                                                            â•‘"
            echo "â•‘  No security issues detected in your code.                 â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
          fi
