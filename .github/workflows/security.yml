# ============================================================================
# ğŸ” Security Static Analysis with Opengrep
# ============================================================================
# Runs Opengrep SAST (Static Application Security Testing) to detect
# security vulnerabilities, code quality issues, and potential bugs.
#
# Features:
# - ğŸ” Scans both frontend (Svelte/TypeScript) and backend (Python) code
# - ğŸ“‹ Uses custom security rules from the security-rules/ directory
# - ğŸ“¤ Uploads SARIF results to GitHub Security tab for visibility
# - ğŸ’¬ Comments on PRs when security findings are detected
# - ğŸš¨ Fails the workflow if critical vulnerabilities are found
# ============================================================================

name: ğŸ” Security Scan

on:
  # Run on all pull requests to protected branches
  pull_request:
    branches:
      - main
      - master
      - develop
    paths:
      - 'frontend/**'
      - 'backend/**'
      - 'security-rules/**'
      - '.github/workflows/security.yml'
  
  # Run on pushes to the default branch
  push:
    branches:
      - main
      - master
    paths:
      - 'frontend/**'
      - 'backend/**'
      - 'security-rules/**'
      - '.github/workflows/security.yml'
  
  # Allow manual trigger for ad-hoc security audits
  workflow_dispatch:
    inputs:
      fail_on_findings:
        description: 'ğŸš¨ Fail workflow if vulnerabilities found'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write    # Required for uploading SARIF to GitHub Security
  pull-requests: write      # Required for commenting on PRs
  actions: read             # Required for workflow status and SARIF upload

env:
  # Opengrep configuration
  OPENGREP_RULES_PATH: security-rules
  OPENGREP_SCAN_PATH: .
  SARIF_OUTPUT: results.sarif

jobs:
  # ============================================================================
  # ğŸ” Security Scan Job
  # ============================================================================
  security-scan:
    name: ğŸ” Opengrep SAST
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      # ----------------------------------------------------------------------
      # ğŸ“¥ Checkout Repository
      # ----------------------------------------------------------------------
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for accurate scanning

      # ----------------------------------------------------------------------
      # ğŸ› ï¸ Install Opengrep
      # ----------------------------------------------------------------------
      - name: ğŸ› ï¸ Install Opengrep
        id: install
        run: |
          echo "ğŸ“¦ Installing Opengrep..."
          
          # Get the latest release version
          OPENGREP_VERSION=$(curl --silent "https://api.github.com/repos/opengrep/opengrep/releases/latest" | \
            grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
          
          if [ -z "$OPENGREP_VERSION" ]; then
            echo "::warning::Could not fetch latest version, using fallback v1.15.0"
            OPENGREP_VERSION="v1.15.0"
          fi
          
          echo "opengrep_version=${OPENGREP_VERSION}" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ Using Opengrep version: $OPENGREP_VERSION"
          
          # Download the full Python CLI binary
          DOWNLOAD_URL="https://github.com/opengrep/opengrep/releases/download/${OPENGREP_VERSION}/opengrep_manylinux_x86"
          echo "â¬‡ï¸ Downloading from: $DOWNLOAD_URL"
          
          curl -fsSL "$DOWNLOAD_URL" -o opengrep || {
            echo "::error::Failed to download Opengrep binary"
            exit 1
          }
          
          # Install binary
          chmod +x opengrep
          sudo mv opengrep /usr/local/bin/opengrep
          
          # Verify installation
          echo "ğŸ“‹ Verifying installation..."
          opengrep --version
          echo "âœ… Opengrep installation complete"

      # ----------------------------------------------------------------------
      # ğŸ“‹ Validate Security Rules
      # ----------------------------------------------------------------------
      - name: ğŸ“‹ Validate security rules
        id: rules
        run: |
          if [ ! -d "${{ env.OPENGREP_RULES_PATH }}" ]; then
            echo "::error::Security rules directory '${{ env.OPENGREP_RULES_PATH }}' not found"
            echo "Please create the directory and add YAML rule files"
            exit 1
          fi
          
          RULE_COUNT=$(find ${{ env.OPENGREP_RULES_PATH }} -name "*.yaml" -o -name "*.yml" | wc -l)
          echo "rule_count=${RULE_COUNT}" >> $GITHUB_OUTPUT
          echo "ğŸ“Š Found ${RULE_COUNT} rule file(s)"
          
          if [ "$RULE_COUNT" -eq 0 ]; then
            echo "::warning::No YAML rule files found in ${{ env.OPENGREP_RULES_PATH }}"
          fi
          
          # List rules for visibility
          echo "ğŸ“ Rule files:"
          find ${{ env.OPENGREP_RULES_PATH }} -name "*.yaml" -o -name "*.yml" | head -20

      # ----------------------------------------------------------------------
      # ğŸ” Run Security Scan
      # ----------------------------------------------------------------------
      - name: ğŸ” Run security scan
        id: scan
        run: |
          echo "ğŸ” Starting security scan..."
          echo "   ğŸ“‹ Rules: ${{ env.OPENGREP_RULES_PATH }}"
          echo "   ğŸ“ Target: ${{ env.OPENGREP_SCAN_PATH }}"
          echo ""
          
          # Run scan with text output for parsing
          echo "Running initial scan..."
          opengrep scan \
            --config ${{ env.OPENGREP_RULES_PATH }} \
            ${{ env.OPENGREP_SCAN_PATH }} \
            2>&1 | tee scan-output.txt || true
          
          # Generate SARIF output
          echo ""
          echo "ğŸ“„ Generating SARIF output..."
          opengrep scan \
            --config ${{ env.OPENGREP_RULES_PATH }} \
            ${{ env.OPENGREP_SCAN_PATH }} \
            --sarif \
            --output ${{ env.SARIF_OUTPUT }} || true
          
          # Parse findings
          FINDING_COUNT=$(grep -oP '\d+(?= Code Findings)' scan-output.txt 2>/dev/null | head -1 || echo "")
          if [ -z "$FINDING_COUNT" ]; then
            FINDING_COUNT=$(grep -oP 'Findings:\s*\K\d+' scan-output.txt 2>/dev/null | head -1 || echo "0")
          fi
          FINDING_COUNT=${FINDING_COUNT:-0}
          echo "finding_count=${FINDING_COUNT}" >> $GITHUB_OUTPUT
          
          # Parse files scanned
          FILES_SCANNED=$(grep -oP 'Scanning \K\d+(?= files)' scan-output.txt 2>/dev/null | head -1 || echo "")
          if [ -z "$FILES_SCANNED" ]; then
            FILES_SCANNED=$(grep -oP '\d+(?= files scanned)' scan-output.txt 2>/dev/null | head -1 || echo "0")
          fi
          echo "files_scanned=${FILES_SCANNED}" >> $GITHUB_OUTPUT
          
          # Parse rules count
          RULES_USED=$(grep -oP 'with \K\d+(?= Code rules)' scan-output.txt 2>/dev/null | head -1 || echo "")
          if [ -z "$RULES_USED" ]; then
            RULES_USED=$(grep -oP '\d+(?= rules)' scan-output.txt 2>/dev/null | head -1 || echo "0")
          fi
          echo "rules_used=${RULES_USED}" >> $GITHUB_OUTPUT
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ“Š SCAN RESULTS                                           â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          printf "â•‘  ğŸ” Findings:    %-41s â•‘\n" "$FINDING_COUNT"
          printf "â•‘  ğŸ“ Files:       %-41s â•‘\n" "$FILES_SCANNED"
          printf "â•‘  ğŸ“‹ Rules:       %-41s â•‘\n" "$RULES_USED"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Verify SARIF generation
          if [ -f "${{ env.SARIF_OUTPUT }}" ]; then
            echo "âœ… SARIF output generated successfully"
          else
            echo "âš ï¸ Creating minimal valid SARIF..."
            cat > ${{ env.SARIF_OUTPUT }} << 'EOFMARKER'
          {
            "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
            "version": "2.1.0",
            "runs": [{
              "tool": {
                "driver": {
                  "name": "Opengrep",
                  "informationUri": "https://opengrep.dev"
                }
              },
              "results": []
            }]
          }
          EOFMARKER
          fi

      # ----------------------------------------------------------------------
      # ğŸ“¤ Upload SARIF to GitHub Security
      # ----------------------------------------------------------------------
      - name: ğŸ“¤ Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: ${{ env.SARIF_OUTPUT }}
          category: opengrep-security-scan

      # ----------------------------------------------------------------------
      # ğŸ“Š Upload Artifacts
      # ----------------------------------------------------------------------
      - name: ğŸ“Š Upload scan artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-scan-results
          path: |
            ${{ env.SARIF_OUTPUT }}
            scan-output.txt
          retention-days: 30

      # ----------------------------------------------------------------------
      # ğŸ“ Generate Summary
      # ----------------------------------------------------------------------
      - name: ğŸ“ Generate workflow summary
        if: always()
        run: |
          FINDING_COUNT="${{ steps.scan.outputs.finding_count }}"
          FILES_SCANNED="${{ steps.scan.outputs.files_scanned }}"
          RULES_USED="${{ steps.scan.outputs.rules_used }}"
          RULE_FILES="${{ steps.rules.outputs.rule_count }}"
          OPENGREP_VERSION="${{ steps.install.outputs.opengrep_version }}"
          
          # Default values
          FINDING_COUNT=${FINDING_COUNT:-0}
          FILES_SCANNED=${FILES_SCANNED:-0}
          RULES_USED=${RULES_USED:-0}
          
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ğŸ” Security Scan Report
          
          EOF
          
          # Status banner
          if [ "$FINDING_COUNT" = "0" ]; then
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          > [!NOTE]
          > ### âœ… All Clear â€” No Security Issues Detected
          > Your code passed all security checks. Great job maintaining secure code! ğŸ‰
          
          EOF
          else
            cat >> $GITHUB_STEP_SUMMARY << EOF
          > [!WARNING]
          > ### âš ï¸ Security Findings Detected: ${FINDING_COUNT} issue(s)
          > Review the findings below and address them before merging.
          
          EOF
          fi
          
          # Metrics
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ### ğŸ“Š Scan Metrics
          
          | Metric | Value |
          |:-------|------:|
          | ğŸ” **Findings** | **${FINDING_COUNT}** |
          | ğŸ“ Files Scanned | ${FILES_SCANNED} |
          | ğŸ“‹ Rules Applied | ${RULES_USED} |
          | ğŸ“¦ Rule Files | ${RULE_FILES} |
          
          EOF
          
          # Show findings if any
          if [ "$FINDING_COUNT" != "0" ] && [ -f "scan-output.txt" ]; then
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ### ğŸš¨ Findings Details
          
          <details>
          <summary>Click to expand scan output</summary>
          
          ```
          EOF
            head -200 scan-output.txt >> $GITHUB_STEP_SUMMARY
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ```
          
          </details>
          
          EOF
          fi
          
          # Configuration
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ### âš™ï¸ Configuration
          
          | Setting | Value |
          |:--------|:------|
          | ğŸ› ï¸ Scanner | Opengrep ${OPENGREP_VERSION} |
          | ğŸ“ Rules Directory | \`${{ env.OPENGREP_RULES_PATH }}/\` |
          | ğŸ¯ Scan Target | \`${{ env.OPENGREP_SCAN_PATH }}\` |
          | ğŸ“„ Output Format | SARIF 2.1.0 |
          | ğŸ“Œ Trigger | \`${{ github.event_name }}\` |
          
          EOF
          
          # Next steps
          if [ "$FINDING_COUNT" != "0" ]; then
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ### ğŸ“‹ Next Steps
          
          1. **ğŸ” Review Findings** â€” Check the [Security tab](../../security/code-scanning) for detailed alerts
          2. **ğŸ”§ Fix Issues** â€” Address high-severity findings first
          3. **ğŸ”„ Re-run Scan** â€” Push fixes and verify the scan passes
          
          > ğŸ’¡ **Tip:** Click on individual alerts in the Security tab to see affected code and remediation guidance.
          
          EOF
          else
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ### ğŸ‰ Keep It Up!
          
          Your codebase is following security best practices. Continue to:
          - ğŸ“‹ Add new security rules as threats evolve
          - ğŸ” Review the [Security tab](../../security/code-scanning) periodically
          - ğŸ“¦ Keep dependencies updated
          
          EOF
          fi
          
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ---
          
          <sub>ğŸ¤– Generated by the Opengrep Security Scan workflow</sub>
          EOF

      # ----------------------------------------------------------------------
      # ğŸ’¬ Comment on PR
      # ----------------------------------------------------------------------
      - name: ğŸ’¬ Comment on PR with findings
        if: github.event_name == 'pull_request' && steps.scan.outputs.finding_count != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const findingCount = '${{ steps.scan.outputs.finding_count }}';
            const filesScanned = '${{ steps.scan.outputs.files_scanned }}';
            const rulesUsed = '${{ steps.scan.outputs.rules_used }}';
            
            const body = `## ğŸ” Security Scan Results
            
            | Metric | Value |
            |:-------|------:|
            | âš ï¸ **Findings** | **${findingCount}** |
            | ğŸ“ Files Scanned | ${filesScanned} |
            | ğŸ“‹ Rules Applied | ${rulesUsed} |
            
            ### ğŸ“‹ Next Steps
            
            1. ğŸ” Check the **[Security tab](../../security/code-scanning)** for detailed findings
            2. ğŸ“ Review the workflow summary for finding details
            3. ğŸ”§ Address high-severity issues before merging
            
            > ğŸ’¡ Click on alerts in the Security tab to see affected code and remediation guidance.
            
            ---
            <sub>ğŸ¤– Generated by Opengrep Security Scan</sub>`;

            // Check for existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const existingComment = comments.find(c => 
              c.user.type === 'Bot' && 
              c.body.includes('ğŸ” Security Scan Results')
            );
            
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      # ----------------------------------------------------------------------
      # ğŸš¨ Fail on Findings
      # ----------------------------------------------------------------------
      - name: ğŸš¨ Check for critical findings
        if: always()
        run: |
          FINDING_COUNT="${{ steps.scan.outputs.finding_count }}"
          FAIL_ON_FINDINGS="${{ github.event.inputs.fail_on_findings || 'true' }}"
          FINDING_COUNT=${FINDING_COUNT:-0}
          
          if [ "$FINDING_COUNT" != "0" ]; then
            echo "::warning::Found ${FINDING_COUNT} security finding(s)"
            
            if [ "$FAIL_ON_FINDINGS" = "true" ]; then
              echo ""
              echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
              echo "â•‘  ğŸš¨ SECURITY SCAN FAILED                                   â•‘"
              echo "â•‘                                                            â•‘"
              printf "â•‘  Found %-3s security finding(s) that need attention.       â•‘\n" "$FINDING_COUNT"
              echo "â•‘                                                            â•‘"
              echo "â•‘  Review the workflow summary and Security tab for details. â•‘"
              echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo ""
              echo "::error::Security scan failed: ${FINDING_COUNT} finding(s) detected"
              exit 1
            else
              echo "::notice::Continuing despite ${FINDING_COUNT} finding(s) (fail_on_findings=false)"
            fi
          else
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘  âœ… SECURITY SCAN PASSED                                   â•‘"
            echo "â•‘                                                            â•‘"
            echo "â•‘  No security issues detected in your code. ğŸ‰              â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
          fi
