# ============================================================================
# ðŸ¤– Auto-Merge Approved PRs
# ============================================================================
# Automatically merges pull requests that are approved and pass all checks.
# Uses pascalgn/automerge-action for reliable auto-merge functionality.
#
# How it works:
#   - PRs with the "automerge" label will be merged when ready
#   - PRs are ready when: approved + all required checks pass + up to date
#   - Uses squash merge strategy by default
#
# See: https://github.com/marketplace/actions/merge-pull-requests-automerge-action
# ============================================================================

name: ðŸ¤– Auto-Merge

on:
  pull_request:
    types:
      - labeled
      - unlabeled
      - synchronize
      - opened
      - edited
      - ready_for_review
      - reopened
      - unlocked
  pull_request_review:
    types:
      - submitted
  check_suite:
    types:
      - completed
  status: {}

concurrency:
  group: auto-merge-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write

jobs:
  # ============================================================================
  # ðŸ¤– Auto-Merge
  # ============================================================================
  automerge:
    name: ðŸ¤– Auto-Merge
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ¤– Run automerge
        id: automerge
        uses: pascalgn/automerge-action@v0.16.4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Merge configuration
          MERGE_LABELS: "automerge,!wip,!do-not-merge"
          MERGE_METHOD: "squash"
          MERGE_COMMIT_MESSAGE: "pull-request-title-and-description"
          MERGE_DELETE_BRANCH: "true"
          MERGE_RETRIES: "6"
          MERGE_RETRY_SLEEP: "10000"
          MERGE_REQUIRED_APPROVALS: "1"
          MERGE_ERROR_FAIL: "false"
          # Update configuration (keep PR up to date with base)
          UPDATE_LABELS: "automerge"
          UPDATE_METHOD: "merge"

      - name: ðŸ“ Generate summary
        if: always()
        run: |
          RESULT="${{ steps.automerge.outputs.mergeResult }}"
          PR_NUMBER="${{ steps.automerge.outputs.pullRequestNumber }}"

          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸ¤– Auto-Merge Summary

          | Property | Value |
          |:---------|:------|
          | ðŸ“Œ Result | \`${RESULT:-N/A}\` |
          | ðŸ”¢ PR Number | ${PR_NUMBER:-N/A} |

          ---

          EOF

          case "$RESULT" in
            "merged")
              cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          > [!TIP]
          > ### âœ… Pull Request Merged
          > The pull request was successfully merged using squash strategy.

          EOF
              ;;
            "not_ready")
              cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          > [!NOTE]
          > ### â³ Not Ready Yet
          > The pull request is not ready to merge. Waiting for:
          > - Required approvals
          > - Required status checks to pass
          > - Branch to be up to date

          EOF
              ;;
            "skipped")
              cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          > [!NOTE]
          > ### â­ï¸ Skipped
          > The pull request was skipped. Ensure it has the `automerge` label.

          EOF
              ;;
            "author_filtered")
              cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          > [!NOTE]
          > ### ðŸ‘¤ Author Filtered
          > The pull request author is not in the allowed list.

          EOF
              ;;
            "merge_failed")
              cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          > [!WARNING]
          > ### âŒ Merge Failed
          > The merge operation failed. Check the logs for details.

          EOF
              ;;
            *)
              cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          > [!NOTE]
          > ### â„¹ï¸ No Action Taken
          > No merge action was performed in this run.

          EOF
              ;;
          esac

          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ### ðŸ“‹ Configuration

          | Setting | Value |
          |:--------|:------|
          | ðŸ·ï¸ Required Labels | `automerge` |
          | ðŸš« Blocking Labels | `wip`, `do-not-merge` |
          | ðŸ”€ Merge Method | Squash |
          | ðŸ—‘ï¸ Delete Branch | Yes |
          | âœ… Required Approvals | 1 |

          ---

          <sub>ðŸ¤– Powered by [automerge-action](https://github.com/pascalgn/automerge-action)</sub>
          EOF
