# ============================================================================
# ðŸ³ Docker Image Build & Publish
# ============================================================================
# Builds multi-platform Docker images and publishes to GitHub Container Registry.
# Generates attestations for supply chain security.
#
# Chain: CI â†’ Release â†’ Docker
# Triggers:
#   - After Release workflow completes (creates versioned images)
#   - On PRs â†’ Build only (validation)
# ============================================================================

name: ðŸ³ Docker Build & Publish

on:
  # Trigger after Release workflow completes
  workflow_run:
    workflows: ["ðŸš€ Release"]
    types: [completed]
    branches: [main, master]
  # Build validation on PRs (no push)
  pull_request:
    branches:
      - master
      - main
  # Manual trigger for debugging
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ============================================================================
  # ðŸ—ï¸ Build & Push Docker Image
  # ============================================================================
  build-and-push:
    name: ðŸ—ï¸ Build & Push
    runs-on: ubuntu-latest
    # Only run if Release succeeded (or PR/manual trigger)
    if: |
      github.event_name == 'pull_request' ||
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'
    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ·ï¸ Get latest tag
        id: get_tag
        run: |
          # For workflow_run, we need to fetch the latest tag
          git fetch --tags
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "tag=${LATEST_TAG}" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ Latest tag: ${LATEST_TAG}"

      - name: ðŸ› ï¸ Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: ðŸ› ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ” Log in to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ·ï¸ Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          # OCI annotations for multi-arch manifest
          annotations: |
            org.opencontainers.image.title=eero-ui
            org.opencontainers.image.description=A modern web dashboard for managing eero mesh WiFi networks
            org.opencontainers.image.url=https://github.com/${{ github.repository }}
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.documentation=https://github.com/${{ github.repository }}/wiki
            org.opencontainers.image.licenses=MIT
            org.opencontainers.image.vendor=${{ github.repository_owner }}
          tags: |
            type=raw,value=latest,enable=${{ github.event_name != 'pull_request' }}
            type=raw,value=${{ steps.get_tag.outputs.tag }},enable=${{ steps.get_tag.outputs.tag != '' && github.event_name != 'pull_request' }}
            type=semver,pattern={{version}},value=${{ steps.get_tag.outputs.tag }}
            type=semver,pattern={{major}}.{{minor}},value=${{ steps.get_tag.outputs.tag }}
            type=semver,pattern={{major}},value=${{ steps.get_tag.outputs.tag }},enable=${{ !startsWith(steps.get_tag.outputs.tag, 'v0.') }}
            type=sha,prefix=
            type=ref,event=pr

      - name: ðŸ“¦ Build and push Docker image
        id: push
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          annotations: ${{ steps.meta.outputs.annotations }}
          # Multi-layer caching strategy for faster builds
          cache-from: |
            type=gha,scope=${{ github.ref_name }}-${{ runner.arch }}
            type=gha,scope=main-${{ runner.arch }}
            type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: |
            type=gha,mode=max,scope=${{ github.ref_name }}-${{ runner.arch }}
            type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache,mode=max,image-manifest=true
          provenance: mode=min
          sbom: true

      - name: ðŸ” Generate artifact attestation
        if: github.event_name != 'pull_request'
        uses: actions/attest-build-provenance@v3
        with:
          subject-name: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          subject-digest: ${{ steps.push.outputs.digest }}
          push-to-registry: true

      - name: ðŸ“Š Generate build summary
        run: |
          IS_PR="${{ github.event_name == 'pull_request' }}"
          LATEST_TAG="${{ steps.get_tag.outputs.tag }}"

          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸ³ Docker Image Build

          EOF

          if [ "$IS_PR" = "true" ]; then
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          > [!NOTE]
          > ### ðŸ” PR Build â€” Validation Only
          > Image built successfully but not pushed to registry.

          EOF
          elif [ -n "$LATEST_TAG" ]; then
            cat >> $GITHUB_STEP_SUMMARY << EOF
          > [!TIP]
          > ### âœ… Release Image Published
          > Version \`${LATEST_TAG}\` has been pushed to GitHub Container Registry!

          EOF
          fi

          cat >> $GITHUB_STEP_SUMMARY << EOF
          ### ðŸ“‹ Image Details

          | Property | Value |
          |:---------|:------|
          | ðŸ“¦ Registry | \`${{ env.REGISTRY }}\` |
          | ðŸ·ï¸ Image | \`${{ env.IMAGE_NAME }}\` |
          | ðŸ—ï¸ Platforms | \`linux/amd64\`, \`linux/arm64\` |
          | âš¡ Cache | GHA + Registry (multi-layer) |
          | ðŸ” SBOM | Generated |
          | ðŸ“ Provenance | Attached |

          ### ðŸ·ï¸ Tags

          \`\`\`
          ${{ steps.meta.outputs.tags }}
          \`\`\`

          EOF

          if [ "$IS_PR" != "true" ]; then
            cat >> $GITHUB_STEP_SUMMARY << EOF
          ### ðŸš€ Quick Start

          \`\`\`bash
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          \`\`\`

          ### âš™ï¸ Workflow Chain

          \`\`\`
          ðŸ§ª CI Pipeline  â”€â”€â†’  ðŸš€ Release  â”€â”€â†’  ðŸ³ Docker Build
               âœ…                  âœ…              âœ…
          \`\`\`

          EOF
          fi

          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ---

          <sub>ðŸ¤– Built with Docker Buildx and GitHub Actions</sub>
          EOF
