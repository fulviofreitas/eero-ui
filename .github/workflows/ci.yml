# ============================================================================
# ðŸ§ª Continuous Integration Pipeline
# ============================================================================
# Chain: Commit Lint â†’ Lint & Format â†’ [Backend Tests â€– Frontend Tests â€– Security â€– Docker] â†’ CI Success
#
# Tests both frontend (Svelte) and backend (FastAPI) components.
# All reusable actions are sourced from fulviofreitas/eero-client/.github/actions/
# ============================================================================

name: ðŸ§ª CI Pipeline

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write
  pull-requests: write
  actions: read

env:
  PYTHON_VERSION: "3.12"
  NODE_VERSION: "20"
  OPENGREP_RULES_PATH: security-rules
  SARIF_OUTPUT: results.sarif

jobs:
  # ============================================================================
  # 1ï¸âƒ£ Commit Lint (Gate 1)
  # ============================================================================
  commitlint:
    name: ðŸ“ Commit Lint
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“ Validate commits
        uses: fulviofreitas/eero-client/.github/actions/commitlint@master
        with:
          from-sha: ${{ github.event.pull_request.base.sha }}
          to-sha: ${{ github.event.pull_request.head.sha }}

  # ============================================================================
  # 2ï¸âƒ£ Backend Lint & Format (Gate 2 - depends on Commit Lint)
  # ============================================================================
  backend-lint:
    name: ðŸ Backend Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: commitlint

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ“¦ Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "backend/pyproject.toml"

      - name: ðŸ Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: ðŸ§¹ Run Python lint
        uses: fulviofreitas/eero-client/.github/actions/python-lint@master
        with:
          src-path: "backend/app/"
          tests-path: "backend/tests/"

  # ============================================================================
  # 2ï¸âƒ£ Frontend Lint & Type Check (Gate 2 - depends on Commit Lint)
  # ============================================================================
  frontend-lint:
    name: âš›ï¸ Frontend Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: commitlint

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ” Run type check & lint
        uses: fulviofreitas/eero-client/.github/actions/frontend-check@master
        with:
          working-directory: frontend
          node-version: ${{ env.NODE_VERSION }}

  # ============================================================================
  # 3ï¸âƒ£ Backend Tests (Parallel - depends on Backend Lint)
  # ============================================================================
  backend-tests:
    name: ðŸ Backend Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: backend-lint

    env:
      EERO_DASHBOARD_SESSION_SECRET: ci-test-secret-not-for-production-use-only

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ“¦ Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "backend/pyproject.toml"

      - name: ðŸ Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: ðŸ“š Install dependencies
        working-directory: backend
        run: uv sync --extra dev

      - name: ðŸ§ª Run tests
        uses: fulviofreitas/eero-client/.github/actions/python-test@master
        with:
          working-directory: backend
          test-path: "tests/"
          src-path: "app"
          upload-coverage: "true"
          codecov-token: ${{ secrets.CODECOV_TOKEN }}

  # ============================================================================
  # 3ï¸âƒ£ Frontend Tests (Parallel - depends on Frontend Lint)
  # ============================================================================
  frontend-tests:
    name: âš›ï¸ Frontend Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: frontend-lint

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ§ª Run tests
        uses: fulviofreitas/eero-client/.github/actions/frontend-test@master
        with:
          working-directory: frontend
          node-version: ${{ env.NODE_VERSION }}

  # ============================================================================
  # 3ï¸âƒ£ Security Scan (Parallel - depends on Commit Lint)
  # ============================================================================
  security-scan:
    name: ðŸ” Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: commitlint

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Run Opengrep scan
        uses: fulviofreitas/eero-client/.github/actions/security-opengrep@master
        with:
          rules-path: ${{ env.OPENGREP_RULES_PATH }}
          target-path: "."
          sarif-output: ${{ env.SARIF_OUTPUT }}
          fail-on-findings: "true"

  # ============================================================================
  # 3ï¸âƒ£ Docker Build Test (Parallel - depends on Lint)
  # ============================================================================
  docker-build:
    name: ðŸ³ Docker Build Test
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [backend-lint, frontend-lint]

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ› ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ³ Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          tags: eero-ui:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================================================
  # 4ï¸âƒ£ CI Success Gate (Final - depends on all parallel jobs)
  # ============================================================================
  ci-success:
    name: âœ… CI Success
    runs-on: ubuntu-latest
    needs: [commitlint, backend-lint, frontend-lint, backend-tests, frontend-tests, security-scan, docker-build]
    if: always()

    steps:
      - name: ðŸ” Check all jobs passed
        run: |
          COMMITLINT="${{ needs.commitlint.result }}"
          BACKEND_LINT="${{ needs.backend-lint.result }}"
          FRONTEND_LINT="${{ needs.frontend-lint.result }}"
          BACKEND="${{ needs.backend-tests.result }}"
          FRONTEND="${{ needs.frontend-tests.result }}"
          SECURITY="${{ needs.security-scan.result }}"
          DOCKER="${{ needs.docker-build.result }}"

          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸ§ª CI Pipeline Summary

          | Stage | Job | Status |
          |:------|:----|:-------|
          | 1ï¸âƒ£ | ðŸ“ Commit Lint | ${COMMITLINT} |
          | 2ï¸âƒ£ | ðŸ Backend Lint | ${BACKEND_LINT} |
          | 2ï¸âƒ£ | âš›ï¸ Frontend Lint | ${FRONTEND_LINT} |
          | 3ï¸âƒ£ | ðŸ Backend Tests | ${BACKEND} |
          | 3ï¸âƒ£ | âš›ï¸ Frontend Tests | ${FRONTEND} |
          | 3ï¸âƒ£ | ðŸ” Security Scan | ${SECURITY} |
          | 3ï¸âƒ£ | ðŸ³ Docker Build | ${DOCKER} |

          EOF

          # All jobs are required to pass
          if [[ "$COMMITLINT" == "success" && "$BACKEND_LINT" == "success" && "$FRONTEND_LINT" == "success" && "$BACKEND" == "success" && "$FRONTEND" == "success" && "$SECURITY" == "success" && "$DOCKER" == "success" ]]; then
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'

          > [!NOTE]
          > ### âœ… All Required Checks Passed
          > CI pipeline completed successfully. Ready for release!

          ---

          ```
          1ï¸âƒ£ ðŸ“ Commit Lint
                 â†“
               â”Œâ”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          2ï¸âƒ£   â”‚              â”‚
          ðŸ Backend Lint  âš›ï¸ Frontend Lint
               â”‚              â”‚
               â†“              â†“
               â”Œâ”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          3ï¸âƒ£   â”‚              â”‚          â”‚         â”‚
          ðŸ Backend Tests âš›ï¸ Frontend  ðŸ” Sec  ðŸ³ Docker
               â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
          4ï¸âƒ£ âœ… CI Success â†’ ðŸš€ Release
          ```

          EOF
            exit 0
          else
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'

          > [!CAUTION]
          > ### âŒ Some Required Checks Failed
          > Review the failed jobs above and fix any issues before merging.

          EOF
            exit 1
          fi
