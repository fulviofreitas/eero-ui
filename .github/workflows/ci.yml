# ============================================================================
# ðŸ§ª Continuous Integration Pipeline
# ============================================================================
# Comprehensive CI that runs all checks: linting, tests, and security scans.
# This is the single source of truth for code quality before release.
#
# Chain: CI â†’ Release â†’ Docker
# ============================================================================

name: ðŸ§ª CI Pipeline

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write
  pull-requests: write
  actions: read

env:
  OPENGREP_RULES_PATH: security-rules
  SARIF_OUTPUT: results.sarif

jobs:
  # ============================================================================
  # ðŸ“ Commit Lint
  # ============================================================================
  commitlint:
    name: ðŸ“ Commit Lint
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: ðŸ”§ Install commitlint
        run: npm install -g @commitlint/cli @commitlint/config-conventional

      - name: ðŸ” Validate commits
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            npx commitlint \
              --from ${{ github.event.pull_request.base.sha }} \
              --to ${{ github.event.pull_request.head.sha }} \
              --verbose
          else
            npx commitlint --last --verbose
          fi

  # ============================================================================
  # ðŸ Backend Tests
  # ============================================================================
  backend-tests:
    name: ðŸ Backend Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    defaults:
      run:
        working-directory: backend

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v6

      - name: ðŸ Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.14'
          cache: 'pip'
          cache-dependency-path: 'backend/pyproject.toml'

      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: ðŸ§ª Run tests with coverage
        env:
          EERO_DASHBOARD_SESSION_SECRET: ci-test-secret-not-for-production-use-only
        run: pytest --cov=app --cov-report=xml --cov-report=term-missing

      - name: ðŸ“Š Upload coverage report
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: backend-coverage
          path: backend/coverage.xml
          retention-days: 30

  # ============================================================================
  # âš›ï¸ Frontend Tests
  # ============================================================================
  frontend-tests:
    name: âš›ï¸ Frontend Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    defaults:
      run:
        working-directory: frontend

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v6

      - name: ðŸ“¦ Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ” Run Svelte check
        run: npm run check

      - name: ðŸ§¹ Run linting
        run: npm run lint

      - name: ðŸ§ª Run tests with coverage
        run: npm run test:coverage

      - name: ðŸ“Š Upload coverage report
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: frontend-coverage
          path: frontend/coverage/
          retention-days: 30

  # ============================================================================
  # ðŸ” Security Scan
  # ============================================================================
  security-scan:
    name: ðŸ” Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: ðŸ› ï¸ Install Opengrep
        id: install
        run: |
          OPENGREP_VERSION=$(curl --silent "https://api.github.com/repos/opengrep/opengrep/releases/latest" | \
            grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
          OPENGREP_VERSION=${OPENGREP_VERSION:-"v1.15.0"}
          echo "opengrep_version=${OPENGREP_VERSION}" >> $GITHUB_OUTPUT
          
          curl -fsSL "https://github.com/opengrep/opengrep/releases/download/${OPENGREP_VERSION}/opengrep_manylinux_x86" -o opengrep
          chmod +x opengrep
          sudo mv opengrep /usr/local/bin/opengrep

      - name: ðŸ” Run security scan
        id: scan
        run: |
          opengrep scan --config ${{ env.OPENGREP_RULES_PATH }} . 2>&1 | tee scan-output.txt || true
          opengrep scan --config ${{ env.OPENGREP_RULES_PATH }} . --sarif --output ${{ env.SARIF_OUTPUT }} || true
          
          FINDING_COUNT=$(grep -oP '\d+(?= Code Findings)' scan-output.txt 2>/dev/null | head -1 || echo "0")
          echo "finding_count=${FINDING_COUNT:-0}" >> $GITHUB_OUTPUT

      - name: ðŸ“¤ Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: ${{ env.SARIF_OUTPUT }}
          category: opengrep-security-scan
        continue-on-error: true

      - name: ðŸ“Š Upload scan artifacts
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: security-scan-results
          path: |
            ${{ env.SARIF_OUTPUT }}
            scan-output.txt
          retention-days: 30

      - name: ðŸš¨ Check for findings
        run: |
          FINDING_COUNT="${{ steps.scan.outputs.finding_count }}"
          if [ "${FINDING_COUNT:-0}" != "0" ]; then
            echo "::warning::Found ${FINDING_COUNT} security finding(s)"
          fi

  # ============================================================================
  # âœ… CI Success Gate
  # ============================================================================
  ci-success:
    name: âœ… CI Success
    runs-on: ubuntu-latest
    needs: [commitlint, backend-tests, frontend-tests, security-scan]
    if: always()

    steps:
      - name: ðŸ” Check all jobs passed
        run: |
          COMMITLINT="${{ needs.commitlint.result }}"
          BACKEND="${{ needs.backend-tests.result }}"
          FRONTEND="${{ needs.frontend-tests.result }}"
          SECURITY="${{ needs.security-scan.result }}"

          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸ§ª CI Pipeline Summary

          | Job | Status |
          |:----|:-------|
          | ðŸ“ Commit Lint | ${COMMITLINT} |
          | ðŸ Backend Tests | ${BACKEND} |
          | âš›ï¸ Frontend Tests | ${FRONTEND} |
          | ðŸ” Security Scan | ${SECURITY} |

          EOF

          # All must pass (security can warn but not fail)
          if [[ "$COMMITLINT" == "success" && "$BACKEND" == "success" && "$FRONTEND" == "success" && ("$SECURITY" == "success" || "$SECURITY" == "skipped") ]]; then
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'

          > [!NOTE]
          > ### âœ… All Checks Passed
          > CI pipeline completed successfully. Ready for release!

          ---

          ```
          ðŸ“ Commit Lint  â”€â”€â”
          ðŸ Backend      â”€â”€â”¼â”€â”€â†’  âœ… CI Success  â”€â”€â†’  ðŸš€ Release  â”€â”€â†’  ðŸ³ Docker
          âš›ï¸ Frontend     â”€â”€â”¤
          ðŸ” Security     â”€â”€â”˜
          ```

          EOF
            exit 0
          else
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'

          > [!CAUTION]
          > ### âŒ Some Checks Failed
          > Review the failed jobs above and fix any issues before merging.

          EOF
            exit 1
          fi
