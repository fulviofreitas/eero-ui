# ============================================================================
# üîê Python Security Rules for Opengrep
# ============================================================================
# These rules detect common security vulnerabilities in Python codebases,
# with a focus on FastAPI and web application security.
#
# Note: Rules are tuned to reduce false positives for this project.
# ============================================================================

rules:
  # --------------------------------------------------------------------------
  # Injection Vulnerabilities
  # --------------------------------------------------------------------------
  - id: python-sql-injection
    languages:
      - python
    message: |
      Potential SQL injection vulnerability. Use parameterized queries
      or ORM methods instead of string formatting.
    severity: ERROR
    pattern-either:
      - pattern: |
          $CURSOR.execute(f"...$VAR...")
      - pattern: |
          $CURSOR.execute("..." % $VAR)
      - pattern: |
          $CURSOR.execute("..." + $VAR)
      - pattern: |
          $CURSOR.execute("...".format($VAR))
    metadata:
      category: security
      subcategory: injection
      cwe: CWE-89
      owasp: A1:2017 - Injection

  - id: python-command-injection
    languages:
      - python
    message: |
      Potential command injection. Use subprocess with shell=False
      and pass arguments as a list.
    severity: ERROR
    pattern-either:
      - pattern: os.system($CMD)
      - pattern: subprocess.call($CMD, shell=True, ...)
      - pattern: subprocess.run($CMD, shell=True, ...)
      - pattern: subprocess.Popen($CMD, shell=True, ...)
    metadata:
      category: security
      subcategory: injection
      cwe: CWE-78
      owasp: A1:2017 - Injection

  - id: python-eval-danger
    languages:
      - python
    message: |
      eval() is dangerous and can execute arbitrary code.
      Use ast.literal_eval() for safe evaluation of literals.
    severity: ERROR
    pattern: eval($EXPR)
    metadata:
      category: security
      subcategory: code-injection
      cwe: CWE-95

  - id: python-exec-danger
    languages:
      - python
    message: |
      exec() is dangerous and can execute arbitrary code.
      Avoid using exec with user-controlled input.
    severity: ERROR
    pattern: exec($EXPR)
    metadata:
      category: security
      subcategory: code-injection
      cwe: CWE-95

  # --------------------------------------------------------------------------
  # Cryptographic Issues
  # --------------------------------------------------------------------------
  - id: python-md5-usage
    languages:
      - python
    message: |
      MD5 is cryptographically broken. Use SHA-256 or SHA-3 for hashing.
    severity: ERROR
    pattern-either:
      - pattern: hashlib.md5(...)
      - pattern: md5($DATA)
    metadata:
      category: security
      subcategory: cryptography
      cwe: CWE-328

  - id: python-sha1-usage
    languages:
      - python
    message: |
      SHA-1 is deprecated for security purposes. Use SHA-256 or SHA-3.
    severity: WARNING
    pattern: hashlib.sha1(...)
    metadata:
      category: security
      subcategory: cryptography
      cwe: CWE-328

  # --------------------------------------------------------------------------
  # Insecure Deserialization
  # --------------------------------------------------------------------------
  - id: python-pickle-insecure
    languages:
      - python
    message: |
      pickle.loads() is insecure - it can execute arbitrary code.
      Use JSON or a safer serialization format.
    severity: ERROR
    pattern-either:
      - pattern: pickle.loads($DATA)
      - pattern: pickle.load($FILE)
    metadata:
      category: security
      subcategory: deserialization
      cwe: CWE-502
      owasp: A8:2017 - Insecure Deserialization

  - id: python-yaml-unsafe
    languages:
      - python
    message: |
      yaml.load() without Loader is insecure. Use yaml.safe_load() instead.
    severity: ERROR
    pattern: yaml.load($DATA)
    metadata:
      category: security
      subcategory: deserialization
      cwe: CWE-502

  # --------------------------------------------------------------------------
  # SSL/TLS Verification
  # --------------------------------------------------------------------------
  - id: python-ssl-verify-disabled
    languages:
      - python
    message: |
      SSL verification is disabled. This is vulnerable to MITM attacks.
      Only disable for testing in isolated environments.
    severity: ERROR
    pattern-either:
      - pattern: requests.$METHOD(..., verify=False, ...)
      - pattern: httpx.$METHOD(..., verify=False, ...)
    paths:
      exclude:
        - "**/test*"
        - "**/*.test.*"
        - "**/conftest.py"
    metadata:
      category: security
      subcategory: ssl
      cwe: CWE-295

  # --------------------------------------------------------------------------
  # FastAPI Specific
  # --------------------------------------------------------------------------
  - id: fastapi-cors-allow-all-production
    languages:
      - python
    message: |
      CORS with allow_origins=["*"] combined with allow_credentials=True
      is insecure and may not work as expected. Use specific origins.
    severity: WARNING
    pattern: |
      CORSMiddleware(..., allow_origins=["*"], allow_credentials=True, ...)
    metadata:
      category: security
      subcategory: cors
      cwe: CWE-942
      framework: fastapi
